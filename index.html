<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wizard Components</title>
</head>
<body>
<div id="app">
    <app inline-template>
        <service-session-selector :service="service"
                                  v-model="session"
        ></service-session-selector>
    </app>
</div>
<script type="text/x-template" id="service-session-selector-template">
    <div>
        <div class="form-row" v-if="isEditing">
            <div class="form-row__label form-row__label--smaller">
                Session
                <span class="loading-inline" v-if="isSessionsLoading"></span>
            </div>
            <div :class="['form-row__input', isSessionsLoading ? 'disabled' : '']" style="padding-top: 4px">
                {{ selectedSessionLabel }}
                <a href="#" @click="editSession">Change</a>
            </div>
        </div>

        <template v-if="!service && !isEditing">
            <div class="description">Please select service to choose available session for booking.</div>
        </template>
        <template v-if="service && !isEditing">
            <div class="form-row" v-if="!selectedDay">
                <div class="form-row__label form-row__label--smaller">
                    Month
                    <span class="loading-inline" v-if="isSessionsLoading"></span>
                </div>
                <div class="form-row__input exclusions-datepicker">
                    <datepicker v-model="selectedDay"
                                :inline="true"
                                @changedMonth="onMonthChange"
                                :disabled="{ customPredictor: isDateDisabled, to: currentDay }"
                                :open-date="selectedMonth"
                                :class="['sessions-datepicker', isSessionsLoading ? 'disabled' : '']"
                                maximum-view="day"
                    ></datepicker>
                </div>
            </div>
            <session-picker v-model="session"
                            :selected-day.sync="selectedDay"
                            :service="service"
                            :sessions="selectedDaySessions"
                            :prev-available-day="prevAvailableDay"
                            :next-available-day="nextAvailableDay"
                            v-else
            ></session-picker>
        </template>
    </div>
</script>
<script type="text/x-template" id="session-picker-template">
    <div>
        <div class="form-row">
            <div class="form-row__label form-row__label--smaller">Date</div>
            <div class="form-row__input" style="padding-top: 3px">
                {{ selectedDayLabel }}  <a href="#" @click="unselectDay">Change</a>
            </div>
        </div>
        <div class="form-row">
            <div class="form-row__label form-row__label--smaller">Duration</div>
            <div class="form-row__input">
                <select v-model="selectedSessionLength" style="width: 100%">
                    <option :value="sessionLength" v-for="sessionLength in service.sessionLengths">
                        {{ sessionLengthLabel(sessionLength) }}
                    </option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-row__label form-row__label--smaller">Session</div>
            <div class="form-row__input">
                <div class="session-picker">
                    <div class="session-picker-header">
                        <span :class="['dashicons dashicons-arrow-left', prevAvailableDay ? '' : 'disabled']" @click="goToPrevDay"></span>
                        <span>{{ selectedDaySessionsLabel }}</span>
                        <span :class="['dashicons dashicons-arrow-right', nextAvailableDay ? '' : 'disabled']" @click="goToNextDay"></span>
                    </div>
                    <div class="session-picker-buttons">
                        <div v-for="session in visibleSessions"
                             @click="select(session)"
                             :class="['session-picker-button', isSelected(session) ? 'session-picker-button--selected' : '']"
                        >
                            {{ sessionLabel(session) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // get default configuration inside the Bottle instance
    require.config({
      paths: {
        bookingWizardComponents: '/dist/lib.min',
        cjs: 'https://rawgit.com/guybedford/cjs/master/cjs',
        'amd-loader': 'https://rawgit.com/guybedford/amd-loader/master/amd-loader',
        stdLib: 'https://unpkg.com/@rebelcode/std-lib@0.1.3/dist/std-lib',
        bottle: 'https://cdnjs.cloudflare.com/ajax/libs/bottlejs/1.6.1/bottle.min',
        vue: 'https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.4/vue',
        axios: 'https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min',
        humanizeDuration: 'https://cdnjs.cloudflare.com/ajax/libs/humanize-duration/3.14.0/humanize-duration.min',
        uiFramework: 'https://unpkg.com/@rebelcode/ui-framework@0.1.1/dist/static/js/uiFramework',
        datepicker: 'https://cdn.jsdelivr.net/npm/vuejs-datepicker@0.9.26/dist/build.min',
        lodash: 'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min',
        moment: 'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min',
        momentRange: 'https://cdnjs.cloudflare.com/ajax/libs/moment-range/4.0.1/moment-range',
      }
    })

    var dependenciesList = ['bookingWizardComponents','uiFramework', 'bottle', 'vue', 'axios', 'humanizeDuration', 'cjs!datepicker',
      'moment', 'lodash', 'cjs!momentRange', 'stdLib']

    function defineServices (di, dependencies) {
      di.factory('vue', function () {
        var Vue = dependencies.vue
        Vue.use(dependencies.uiFramework.Core.InjectedComponents)
        return Vue
      })

      di.factory('app', function () {
        return {
          inject: ['service-session-selector'],
          data: function () {
            return {
              service: {"id":29,"name":"simple","bookingsEnabled":"1","sessionLengths":[{"sessionLength":3600,"price":{"amount":"35","currency":"USD","formatted":"$35.00"}}],"displayOptions":{"useCustomerTimezone":false},"timezone":"UTC+0","availabilities":{"rules":[]}},
              session: null
            }
          },
          components: {
            'service-session-selector': 'service-session-selector',
          }
        }
      })

      di.factory('components', function (container) {
        return {
          app: container.app,
          'service-session-selector': container['service-session-selector'],
          'session-picker': container['session-picker'],
          datepicker: container.datepicker
        }
      })

      di.factory('humanizeDuration', function () {
        return dependencies.humanizeDuration
      })

      di.factory('datepicker', function (container) {
        return dependencies.datepicker
      })

      di.factory('moment', function (container) {
        var moment = dependencies.moment
        return dependencies.momentRange.extendMoment(moment)
        return moment
      })

      di.factory('service-session-selector', function (container) {
        console.info(dependencies)
        return dependencies.bookingWizardComponents.CfServiceSessionSelector(container.moment, container.sessionApi, container.config.datetime)
      })

      di.factory('session-picker', function (container) {
        return dependencies.bookingWizardComponents.CfSessionPicker(container.moment, container.config.datetime)
      })

      di.factory('sessionApi', function (container) {
        return new dependencies.bookingWizardComponents.SessionApi(
          dependencies.axios,
          container.config.endpoints.sessions,
          (new dependencies.stdLib.RequestCache(function (s) {
            return s
          })),
          (new dependencies.bookingWizardComponents.RangeCache(container.moment, dependencies.lodash.differenceWith, dependencies.lodash.isEqual)),
          container.sessionReadTransformer,
          container.moment
        )
      })

      di.factory('config', function () {
        return {
          endpoints: {
            sessions: {
              'fetch': {
                'method': 'get',
                'endpoint': 'http://scotchbox.local/index.php?rest_route=/eddbk/v1/sessions/',
              }
            }
          },
          datetime: {
            'tzFree': 'YYYY-MM-DD HH:mm:ss',
            'store': 'YYYY-MM-DDTHH:mm:ssZ',
            'sessionTime': 'h:mm a',
            'dayFull': 'dddd Do MMMM YYYY',
            'dayShort': 'D MMMM YYYY',
            'monthKey': 'YYYY-MM',
            'dayKey': 'YYYY-MM-DD'
          }
        }
      })

      di.factory('sessionReadTransformer', function (container) {
        return new dependencies.bookingWizardComponents.SessionReadTransformer(container.moment)
      })

      di.factory('document', function () {
        return document
      })

      di.factory('selectorList', function () {
        return [
          '#app',
        ]
      })
    }

    require(dependenciesList, function () {
      var dependencies = {}
      for (var i = 0; i < dependenciesList.length; i++) {
        dependencies[dependenciesList[i].replace('cjs!', '')] = arguments[i]
      }
      var di = new dependencies.bottle()

      defineServices(di, dependencies)
      var container = new dependencies.uiFramework.Container.Container(di)
      var app = new dependencies.uiFramework.Core.App(container)
      app.init()
    })
  })

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>
</body>
</html>